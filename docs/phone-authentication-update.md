# تحديث نظام المصادقة - استخدام رقم الجوال للطلاب

## التغييرات المنفذة

### 1. قاعدة البيانات
- ✅ جعل حقل `email` في جدول `users` اختيارياً (NULL)
- ✅ جعل حقل `phone` إلزامياً وفريداً (UNIQUE)
- ✅ إضافة index على حقل `phone` لتحسين الأداء

### 2. نظام المصادقة (Auth.php)
- ✅ تحديث دالة `attempt()` لقبول رقم الجوال أو البريد الإلكتروني
- ✅ التحقق التلقائي من نوع المُعرّف (email أو phone) باستخدام `FILTER_VALIDATE_EMAIL`

### 3. Controller التسجيل (AuthController.php)
#### تسجيل الدخول:
- ✅ تغيير حقل `email` إلى `identifier` (يقبل رقم جوال أو بريد)
- ✅ تحديث رسالة الخطأ لتشمل "رقم الجوال أو كلمة المرور"

#### تسجيل الطلاب:
- ✅ جعل `phone` مطلوب أولاً في الـ validation
- ✅ جعل `email` اختيارياً
- ✅ التحقق من فرادة `phone` بدلاً من `email`
- ✅ التحقق من فرادة `email` فقط إذا تم إدخاله
- ✅ Auto-login بعد التسجيل باستخدام رقم الجوال

### 4. واجهة المستخدم

#### صفحة تسجيل الدخول (login.php):
```php
// قبل:
<input type="email" name="email" required>

// بعد:
<input type="text" name="identifier" placeholder="0599123456 أو email@example.com">
```

#### صفحة تسجيل الطلاب (register_student.php):
- ✅ نقل حقل رقم الجوال للأعلى (بجانب الاسم)
- ✅ إضافة ملاحظة "ستستخدمه لتسجيل الدخول"
- ✅ جعل البريد الإلكتروني اختيارياً مع تسمية واضحة
- ✅ إضافة placeholder لرقم الجوال: `0599123456`

## استخدام النظام الجديد

### للطلاب:

**التسجيل:**
1. أدخل الاسم الكامل
2. أدخل رقم الجوال (إلزامي) - سيُستخدم لتسجيل الدخول
3. البريد الإلكتروني (اختياري)
4. بقية البيانات...

**تسجيل الدخول:**
- يمكن الدخول برقم الجوال: `0599123456`
- أو بالبريد الإلكتروني إذا تم إدخاله: `student@example.com`

### للمنسقين والإداريين:
- لا تغيير - يمكنهم الاستمرار باستخدام البريد الإلكتروني

## Migration

تنفيذ التغييرات على قاعدة البيانات:

```powershell
# طريقة PowerShell
Get-Content database\migrations\2026_02_08_make_email_nullable_add_phone_unique.sql | C:\xampp\mysql\bin\mysql.exe -u root psop_db

# أو طريقة CMD
type database\migrations\2026_02_08_make_email_nullable_add_phone_unique.sql | C:\xampp\mysql\bin\mysql.exe -u root psop_db
```

## ملاحظات مهمة

1. **أرقام الجوال الموجودة**: تأكد من عدم وجود أرقام جوال مكررة في البيانات الحالية
2. **التوافق**: النظام يدعم كلا الطريقتين (email و phone) لتسجيل الدخول
3. **منسقي المدارس والإداريين**: لم يتأثروا - البريد الإلكتروني لا يزال إلزامياً لهم في نموذجهم الخاص

## الملفات المعدلة

```
src/
├── Controllers/
│   └── AuthController.php
└── Core/
    └── Auth.php

views/
└── auth/
    ├── login.php
    └── register_student.php

database/
└── migrations/
    └── 2026_02_08_make_email_nullable_add_phone_unique.sql
```

## اختبار

للاختبار:
1. قم بتسجيل طالب جديد باستخدام رقم جوال فقط
2. حاول تسجيل الدخول برقم الجوال
3. تحقق من عدم القدرة على تسجيل نفس رقم الجوال مرتين
4. اختبر تسجيل الدخول بالبريد الإلكتروني للمستخدمين الذين لديهم بريد

## رمز الإصدار
- **التاريخ**: 8 فبراير 2026
- **الإصدار**: 1.1.0
- **الميزة**: Phone-based authentication for students
