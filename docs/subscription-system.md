# نظام الاشتراكات السنوية

تم إنشاء نظام اشتراكات سنوي كامل للبوابة. النظام يتطلب من الطلاب والمدارس تفعيل اشتراك نشط قبل التسجيل في المسابقات.

## المكونات المضافة

### 1. قاعدة البيانات
- **subscription_plans**: خطط الاشتراك (طالب سنوي $50، مدرسة سنوية $200، طالب تجريبي مجاني)
- **user_subscriptions**: اشتراكات المستخدمين مع تتبع حالة الدفع والتواريخ

### 2. Models
- **SubscriptionPlan.php**: إدارة خطط الاشتراك
- **UserSubscription.php**: إدارة اشتراكات المستخدمين مع التحقق من النشط

### 3. Controllers
- **SubscriptionController.php**: يحتوي على:
  - `plans()`: عرض خطط الاشتراك
  - `subscribe()`: الاشتراك في خطة
  - `payment()`: صفحة الدفع
  - `confirmPayment()`: تأكيد الدفع وتفعيل الاشتراك
  - `mySubscription()`: عرض اشتراك المستخدم
  - `adminList()`: إدارة الاشتراكات (أدمن)
  - `adminActivate()`: تفعيل اشتراك يدوياً (أدمن)

### 4. Views
- **subscriptions/plans.php**: صفحة عرض خطط الاشتراك بتصميم احترافي
- **subscriptions/payment.php**: صفحة الدفع مع خيارات متعددة
- **subscriptions/my-subscription.php**: عرض اشتراك المستخدم وسجل الاشتراكات
- **admin/subscriptions/list.php**: إدارة الاشتراكات للأدمن

### 5. التكامل مع النظام
- **RegistrationController**: إضافة التحقق من الاشتراك النشط قبل السماح بالتسجيل
- **DashboardController**: عرض حالة الاشتراك في لوحة تحكم الطالب
- **Dashboard Layout**: إضافة روابط الاشتراكات في القائمة الجانبية

## المسارات الجديدة

### للمستخدمين
- `/subscriptions/plans` - عرض خطط الاشتراك
- `/subscriptions/subscribe` - الاشتراك (POST)
- `/subscriptions/payment/{id}` - صفحة الدفع
- `/subscriptions/confirm-payment` - تأكيد الدفع (POST)
- `/subscriptions/my-subscription` - اشتراكي

### للأدمن
- `/admin/subscriptions` - قائمة الاشتراكات
- `/admin/subscriptions/activate` - تفعيل اشتراك (POST)

## كيف يعمل النظام

1. **الطالب يختار خطة**: يذهب لصفحة الخطط ويختار خطة مناسبة
2. **صفحة الدفع**: يتم إنشاء اشتراك بحالة `pending` ويذهب لصفحة الدفع
3. **تأكيد الدفع**: بعد الدفع، يتم تحديث حالة الاشتراك إلى `active`
4. **التحقق عند التسجيل**: عند محاولة التسجيل في مسابقة، يتحقق النظام من وجود اشتراك نشط
5. **عرض في Dashboard**: يظهر تنبيه في لوحة التحكم بحالة الاشتراك

## الميزات

✅ خطط اشتراك متعددة (طالب، مدرسة، تجريبي)
✅ تتبع حالة الاشتراك (pending, active, expired, cancelled)
✅ تتبع حالة الدفع (unpaid, paid, refunded)
✅ عرض الأيام المتبقية في الاشتراك
✅ منع التسجيل في المسابقات بدون اشتراك نشط
✅ سجل كامل للاشتراكات
✅ إدارة كاملة للأدمن مع إحصائيات
✅ تفعيل يدوي للاشتراكات من الأدمن

## التجربة

1. افتح `http://localhost/psop/public/subscriptions/plans`
2. اختر خطة اشتراك
3. أكمل عملية الدفع (تجريبية حالياً)
4. سيتم تفعيل الاشتراك تلقائياً للخطط المجانية
5. للخطط المدفوعة، يمكن للأدمن التفعيل يدوياً من `/admin/subscriptions`

## ملاحظات

- النظام حالياً يقبل أي معلومات دفع ويفعل فوراً (للتطوير)
- في الإنتاج، يجب تكامل مع بوابة دفع حقيقية (PayPal, Stripe, إلخ)
- يوجد جدول مهام لتحديث الاشتراكات المنتهية تلقائياً
